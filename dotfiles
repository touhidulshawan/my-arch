#!/usr/bin/env sh
set -e

# TTY-safe colors
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RED="\033[1;31m"
BLUE="\033[1;34m"
NC="\033[0m" # No color

echo -e "${BLUE}=== Dotfiles setup is in progress... ===${NC}\n"

DOTFILES_DIR="$HOME/.dotfiles"
REPO="git@github.com:touhidulshawan/dotfiles.git"

# Create .dotfiles directory
echo -e "${YELLOW}[INFO] Creating $DOTFILES_DIR directory...${NC}"
mkdir -p "$DOTFILES_DIR"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[OK] Directory created: $DOTFILES_DIR${NC}\n"
else
    echo -e "${RED}[ERROR] Failed to create $DOTFILES_DIR${NC}"
    exit 1
fi

# Clone the bare repository
echo -e "${YELLOW}[INFO] Cloning dotfiles repository...${NC}"
git clone --bare "$REPO" "$DOTFILES_DIR"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[OK] Repository cloned successfully!${NC}\n"
else
    echo -e "${RED}[ERROR] Failed to clone repository${NC}"
    exit 1
fi

# Define the config function for git operations
config() {
    /usr/bin/git --git-dir="$DOTFILES_DIR/" --work-tree="$HOME" "$@"
}

# Checkout dotfiles to the home directory
echo -e "${YELLOW}[INFO] Checking out dotfiles...${NC}"
if config checkout; then
    echo -e "${GREEN}[OK] Dotfiles checked out successfully${NC}\n"
else
    echo -e "${RED}[WARNING] Conflicts detected. Resolve manually.${NC}\n"
fi

# Hide untracked files in the status
echo -e "${YELLOW}[INFO] Configuring git to hide untracked files...${NC}"
if config config status.showUntrackedFiles no; then
    echo -e "${GREEN}[OK] Untracked files hidden${NC}\n"
else
    echo -e "${RED}[ERROR] Failed to configure git${NC}"
    exit 1
fi

echo -e "${BLUE}=== Dotfiles setup completed successfully! ===${NC}\n"
