#!/usr/bin/env bash
set -euo pipefail

FILE="./packages.txt"

# Colors (TTY-safe ANSI)
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RED="\033[1;31m"
BLUE="\033[1;34m"
NC="\033[0m" # No color

# Check if the file exists
if [ ! -f "$FILE" ]; then
    echo -e "${RED}[ERROR] File $FILE not found!${NC}"
    exit 1
fi

# Header
echo -e "${BLUE}=== Starting package installation ===${NC}\n"

# Counters
count_total=0
count_skipped=0
count_success=0
count_fail=0

# Read the file and install each package
while IFS= read -r app || [[ -n "$app" ]]; do
    # Trim whitespace
    app="$(echo "$app" | xargs)"

    # Skip empty lines and comments
    [[ -z "$app" || "$app" =~ ^# ]] && continue

    count_total=$((count_total+1))

    # Check if package is already installed
    if pacman -Q "$app" &>/dev/null; then
        echo -e "${YELLOW}[SKIP] $app is already installed${NC}"
        count_skipped=$((count_skipped+1))
        echo -e "\n----------------------------------------\n"
        continue
    fi

    # Install package
    echo -e "${YELLOW}[INSTALLING] $app...${NC}"
    if doas pacman --noconfirm -S "$app"; then
        echo -e "${GREEN}[SUCCESS] $app installed!${NC}"
        count_success=$((count_success+1))
    else
        echo -e "${RED}[FAIL] Could not install $app${NC}"
        count_fail=$((count_fail+1))
    fi

    # Separator for readability
    echo -e "\n----------------------------------------\n"

done < "$FILE"

# Summary
echo -e "${BLUE}=== Installation completed ===${NC}"
echo -e "Total packages in list: $count_total"
echo -e "${GREEN}Installed successfully: $count_success${NC}"
echo -e "${YELLOW}Skipped (already installed): $count_skipped${NC}"
echo -e "${RED}Failed installations: $count_fail${NC}"
